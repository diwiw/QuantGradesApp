name: CI â€¢ Production Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write

jobs:
  build-and-test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Ubuntu â€¢ Debug"
            os: ubuntu-latest
            preset: linux-debug
            build_preset: build-linux-debug
            test_preset: test-unit-linux
          - name: "Ubuntu â€¢ Release"
            os: ubuntu-latest
            preset: linux-release
            build_preset: build-linux-release
          - name: "Windows â€¢ Release"
            os: windows-latest
            preset: windows-release
            build_preset: build-windows-release

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      # --- OS SPECIFIC SETUP ---
      - name: Setup Linux Tools
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update && sudo apt-get install -y ninja-build ccache
          echo "VCPKG_ROOT=$VCPKG_INSTALLATION_ROOT" >> $GITHUB_ENV

      - name: Setup Windows Tools
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja sccache --no-progress
          echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" >> $env:GITHUB_ENV

      - name: Activate MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # --- CACHING ---
      - name: Compiler & VCPKG Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            ~\AppData\Local\Mozilla\sccache
            ${{ github.workspace }}/build/${{ matrix.preset }}/vcpkg_installed
            ${{ github.workspace }}/vcpkg_installed
          key: ${{ runner.os }}-${{ matrix.preset }}-${{ hashFiles('vcpkg.json') }}-${{ github.sha }}
          restore-keys:
            ${{ runner.os }}-${{ matrix.preset }}-${{ hashFiles('vcpkg.json') }}-

      # --- BUILD ---
      - name: Configure & Build
        shell: bash
        run: |
          cmake --preset ${{ matrix.preset }}
          cmake --build --preset ${{ matrix.build_preset }} --parallel

      # --- RUN DEMOS (Exact logic from your working version) ---
      - name: Run Demos
        shell: bash
        run: |
          BIN_DIR="build/${{ matrix.preset }}/bin"
          if [ -d "$BIN_DIR" ]; then
            cd "$BIN_DIR"
            cp ../../../config.json . 2>/dev/null || true
            for d in logger_demo grades_demo backtest_demo; do
              exe="./$d"; [ -f "$d.exe" ] && exe="./$d.exe"
              if [ -f "$exe" ]; then $exe || exit 1; fi
            done
          fi

      # --- PACKAGING (Only on Tags) ---
      - name: Package & SHA256
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          cmake --install build/${{ matrix.preset }} --prefix bundle/qga
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a "qga-${{ matrix.preset }}.zip" ./bundle/qga/*
          else
            tar -czf "qga-${{ matrix.preset }}.tar.gz" -C bundle qga
          fi
          sha256sum qga-* > checksum.sha256

      - name: Upload Artifacts
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.preset }}-bundle
          path: |
            qga-*
            checksum.sha256

  # --- TSAN (ThreadSanitizer) ---
  tsan:
    name: "linux-tsan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang ninja-build
          echo "VCPKG_ROOT=$VCPKG_INSTALLATION_ROOT" >> $GITHUB_ENV

      - name: Build & Test (TSan)
        run: |
          # We force Clang and RelWithDebInfo to get clear stack traces
          cmake -S . -B build-tsan -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DENABLE_TSAN=ON \
            -DENABLE_ASAN=OFF \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DVCPKG_ROOT=$VCPKG_ROOT

          cmake --build build-tsan --parallel

          # TSAN_OPTIONS: halt_on_error=1 means fail the build immediately on race
          export TSAN_OPTIONS="halt_on_error=1 second_deadlock_stack=1"
          ctest --test-dir build-tsan --output-on-failure

  # --- RELEASE ---
  release:
    name: "ðŸš€ Publish Release"
    needs: [build-and-test, tsan]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with: { path: artifacts, pattern: '*-bundle' }
      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
