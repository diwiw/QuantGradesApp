name: CI â€¢ Build & Test

on:
  push:
    branches: [ main, develop ]
    tags:
      - v*
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write

jobs:
  ubuntu-build:
    name: Ubuntu â€¢ Build & Test (with ccache)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('vcpkg.json') }}
          restore-keys: ${{ runner.os }}-apt-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build pkg-config ccache \
            libcurl4-openssl-dev libsqlite3-dev \
            libspdlog-dev libfmt-dev

      - name: Setup ccache
        run: |
          echo "max_size = 2G" | sudo tee /etc/ccache.conf
          export PATH="/usr/lib/ccache:$PATH"
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          ccache --zero-stats

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.hpp') }}
          restore-keys: ${{ runner.os }}-ccache-

      - name: Clean previous CMake cache
        run: rm -rf build

      - name: Configure
        run: |
          cmake -S . -B build -G Ninja \
            -DBUILD_API=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DBUILD_EXAMPLES=ON \
            -DBUILD_DOCS=OFF \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: List built targets
        run: cmake --build build --target help | grep demo || true

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

      - name: Generate and Upload Demo Outputs
        if: success()
        run: |
          if [ -f ./build/demo_db_logger_config ]; then
            echo "Generating demo output files..."
            ./build/demo_db_logger_config
          else
            echo "Skipping demo run (binary not found)"
          fi
        shell: bash

      - name: Upload Demo Outputs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: DemoOutputs-Ubuntu-${{ github.run_number }}
          path: |
            build/demo_out.csv
            build/demo_out.json
            demo_out.csv
            demo_out.json
          if-no-files-found: warn

      - name: Install bundle (Linux)
        if: success()
        run: |
          rm -rf bundle
          cmake --install build --prefix bundle/quantgrades
          echo "Bundle tree:"
          find bundle -maxdepth 3 -type f -print

      - name: Create tar.gz (Linux)
        if: success()
        run: |
          tar -czf quantgrades-linux-x64.tar.gz -C bundle quantgrades
          ls -lh quantgrades-linux-x64.tar.gz

      - name: SHA256 (Linux)
        if: success()
        run: sha256sum quantgrades-linux-x64.tar.gz > quantgrades-linux-x64.sha256

      - name: Upload Linux bundle
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: quantgrades-linux-bundle
          path: |
            quantgrades-linux-x64.tar.gz
            quantgrades-linux-x64.sha256
          if-no-files-found: error

  ubuntu-tsan:
    name: Ubuntu â€¢ ThreadSanitizer (TSan)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies for TSan
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build ccache pkg-config \
            libcurl4-openssl-dev libsqlite3-dev \
            libspdlog-dev libfmt-dev

      - name: Setup ccache
        run: |
          echo "max_size = 2G" | sudo tee /etc/ccache.conf
          export PATH="/usr/lib/ccache:$PATH"
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
          ccache --zero-stats

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-tsan-ccache-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.hpp') }}
          restore-keys: ${{ runner.os }}-tsan-ccache-

      - name: Configure (TSan)
        run: |
          cmake -S . -B build-tsan -G Ninja \
            -DBUILD_API=ON \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DENABLE_TSAN=ON \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF

      - name: Build (TSan)
        run: cmake --build build-tsan --parallel

      - name: Run Tests (TSan)
        run: |
          ASAN_OPTIONS=halt_on_error=0:detect_leaks=0 \
          TSAN_OPTIONS="halt_on_error=0 second_deadlock_stack=1 suppressions=${{ github.workspace }}/.tsan-suppressions.txt" \
          ctest --test-dir build-tsan --output-on-failure || echo "TSan run completed with warnings"

      - name: Upload TSan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ThreadSanitizer-Reports
          path: |
            build-tsan/Testing/Temporary/*.log
            build-tsan/*.tsan
          if-no-files-found: ignore

      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

  windows-build:
    name: Windows â€¢ Build & Test (MSVC + vcpkg + sccache)
    runs-on: windows-latest

    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_OVERLAY_TRIPLETS: ${{ github.workspace }}\vcpkg_triplets
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      CMAKE_BUILD_PARALLEL_LEVEL: 2
      SCCACHE_DIR: C:\sccache
      SCCACHE_LOG: error

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Activate MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        shell: cmd
        run: |
          curl -L -o ninja.zip https://github.com/ninja-build/ninja/releases/download/v1.12.1/ninja-win.zip
          mkdir C:\ninja
          tar -xf ninja.zip -C C:\ninja
          echo C:\ninja>> %GITHUB_PATH%

      - name: Install sccache
        shell: cmd
        run: |
          curl -L -o sccache.zip https://github.com/mozilla/sccache/releases/download/v0.8.2/sccache-v0.8.2-x86_64-pc-windows-msvc.zip
          mkdir C:\sccache
          tar -xf sccache.zip -C C:\sccache
          for /d %%D in (C:\sccache\sccache-v*) do (move %%D\sccache.exe C:\sccache\sccache.exe >nul 2>&1)
          echo C:\sccache>> %GITHUB_PATH%

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: C:\sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/*.cpp', '**/*.hpp', '**/CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-sccache-

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/buildtrees
            vcpkg/downloads
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: ${{ runner.os }}-vcpkg-

      - name: Setup vcpkg manually
        shell: cmd
        run: |
          if exist vcpkg (rmdir /s /q vcpkg)
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          git checkout 62324000504cdd27282f8275c99135cfb2bd1dc0
          .\bootstrap-vcpkg.bat -disableMetrics

      - name: Verify Tools
        shell: cmd
        run: |
          where cl
          where ninja
          where sccache
          cl /Bv
          ninja --version

      - name: Configure (Windows)
        shell: cmd
        run: |
          set "VCPKG_ROOT=%GITHUB_WORKSPACE%\vcpkg"
          set "VCPKG_USE_SYSTEM_NINJA=1"
          echo VCPKG_ROOT set to: %VCPKG_ROOT%

          cmake -S . -B build -G "Ninja" ^
            -DCMAKE_BUILD_TYPE=Release ^
            "-DCMAKE_TOOLCHAIN_FILE=%GITHUB_WORKSPACE%\vcpkg\scripts\buildsystems\vcpkg.cmake" ^
            -DVCPKG_TARGET_TRIPLET=x64-windows-static ^
            "-DVCPKG_OVERLAY_TRIPLETS=%GITHUB_WORKSPACE%\vcpkg_triplets" ^
            -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded ^
            "-DCMAKE_MAKE_PROGRAM=C:\ninja\ninja.exe" ^
            -DBUILD_EXAMPLES=ON -DBUILD_DOCS=OFF -DBUILD_API=ON ^
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build (Release)
        shell: cmd
        run: cmake --build build --parallel

      - name: Run Tests
        shell: cmd
        run: ctest --test-dir build --output-on-failure -V

      - name: Install bundle (Windows)
        if: success()
        shell: cmd
        run: |
          rmdir /s /q bundle 2>nul
          cmake --install build --prefix bundle\quantgrades_api
          echo Bundle tree:
          dir /s /b bundle

      - name: Create zip (Windows)
        if: success()
        shell: powershell
        run: |
          Compress-Archive bundle\quantgrades_api quantgrades_api-windows-x64.zip
          Get-Item quantgrades_api-windows-x64.zip | Format-List *

      - name: SHA256 (Windows)
        if: success()
        shell: powershell
        run: |
          $h = (Get-FileHash quantgrades_api-windows-x64.zip -Algorithm SHA256).Hash
          "$h  quantgrades_api-windows-x64.zip" | Out-File -Encoding ascii -FilePath quantgrades_api-windows-x64.sha256
          type quantgrades_api-windows-x64.sha256

      - name: Upload Windows bundle
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: quantgrades_api-windows-bundle
          path: |
            quantgrades_api-windows-x64.zip
            quantgrades_api-windows-x64.sha256
          if-no-files-found: error

      - name: Upload Compiler Detection Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: CompilerDetectionLogs
          path: vcpkg/buildtrees/detect_compiler/**/*.log

      - name: Upload vcpkg logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-logs
          path: vcpkg/buildtrees/**/*.log

      - name: Dump vcpkg + CMake logs (if failure)
        if: failure()
        shell: cmd
        run: |
          dir /s /b vcpkg\buildtrees\detect_compiler || echo (no detect_compiler directory)
          type vcpkg\buildtrees\detect_compiler\config-x64-windows-static-rel-CMakeCache.txt.log || echo (missing)
          type vcpkg\buildtrees\detect_compiler\config-x64-windows-static-out.log || echo (missing)
          type build\CMakeFiles\CMakeOutput.log || echo (no CMakeOutput.log)
          type build\CMakeFiles\CMakeError.log || echo (no CMakeError.log)
          exit /b 0

  publish_release:
    name: "ðŸš€ Publish GitHub Release (attach bundles)"
    runs-on: ubuntu-latest
    needs:
      - ubuntu-build
      - windows-build
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux bundle
        uses: actions/download-artifact@v4
        with:
          name: quantgrades-linux-bundle
          path: dist/linux

      - name: Download Windows bundle
        uses: actions/download-artifact@v4
        with:
          name: quantgrades_api-windows-bundle
          path: dist/windows

      - name: List files
        run: |
          echo "=== dist/linux ==="
          ls -lh dist/linux || true
          echo "=== dist/windows ==="
          ls -lh dist/windows || true

      - name: Verify SHA256 (Linux)
        run: |
          cd dist/linux
          sha256sum -c quantgrades-linux-x64.sha256 || true

      - name: Attach assets to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/linux/quantgrades-linux-x64.tar.gz
            dist/linux/quantgrades-linux-x64.sha256
            dist/windows/quantgrades_api-windows-x64.zip
            dist/windows/quantgrades_api-windows-x64.sha256
          generate_release_notes: true
          draft: false
          prerelease: false
