name: CI

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "linux-debug"
            os: ubuntu-latest
            preset: linux-debug
            build_preset: build-linux-debug
          - name: "linux-release"
            os: ubuntu-latest
            preset: linux-release
            build_preset: build-linux-release
          - name: "windows-release"
            os: windows-latest
            preset: windows-release
            build_preset: build-windows-release

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Dependencies
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y ninja-build ccache
          else
            choco install ninja sccache --no-progress
          fi

      - name: Build
        shell: bash
        run: |
          V_ROOT=$VCPKG_INSTALLATION_ROOT
          cmake --preset ${{ matrix.preset }} -DVCPKG_ROOT="$V_ROOT"
          cmake --build --preset ${{ matrix.build_preset }} --parallel

      - name: Run Demos
        shell: bash
        run: |
          BIN_DIR="build/${{ matrix.preset }}/bin"
          if [ -d "$BIN_DIR" ]; then
            cd "$BIN_DIR"
            for f in *_demo *_demo.exe; do
              if [ -f "$f" ]; then
                echo "Running $f..."
                ./$f || exit 1
              fi
            done
          fi

      - name: Package
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          cmake --install build/${{ matrix.preset }} --prefix dist
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a "qga-${{ matrix.name }}.zip" ./dist/*
          else
            tar -czf "qga-${{ matrix.name }}.tar.gz" -C dist .
          fi

      - name: Upload Artifacts
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-package
          path: qga-*

  tsan:
    name: "linux-tsan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: sudo apt-get update && sudo apt-get install -y clang ninja-build
      - name: Build & Test
        run: |
          cmake -S . -B build-tsan -G Ninja -DENABLE_TSAN=ON \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DVCPKG_ROOT=$VCPKG_INSTALLATION_ROOT
          cmake --build build-tsan --parallel
          export TSAN_OPTIONS="halt_on_error=1"
          ctest --test-dir build-tsan --output-on-failure

  release:
    name: "Publish Release"
    needs: [build, tsan]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with: { path: artifacts, pattern: '*-package' }
      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
